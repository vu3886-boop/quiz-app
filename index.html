<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quiz App - Admin & Guest</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 700px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    input, button, textarea {
      font-family: Arial, sans-serif;
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    .hidden { display: none; }
    .question {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .answers label { display: block; }
    .admin-actions {
      display: flex;
      justify-content: space-between;
    }
    .result {
      text-align: center;
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container" id="loginContainer">
    <h1>Đăng nhập</h1>
    <input type="text" id="username" placeholder="Tài khoản">
    <input type="password" id="password" placeholder="Mật khẩu">
    <button onclick="login()">Đăng nhập</button>
    <p id="loginMessage" style="color:red;text-align:center;"></p>
  </div>

  <div class="container hidden" id="adminContainer">
    <h2>Chào mừng Admin</h2>
    <div id="questionList"></div>
    <h3>Thêm câu hỏi mới</h3>
    <input type="text" id="newQuestion" placeholder="Nội dung câu hỏi">
    <textarea id="newAnswers" placeholder="Nhập 4 đáp án, mỗi đáp án trên 1 dòng"></textarea>
    <input type="number" id="newCorrect" min="1" max="4" placeholder="Đáp án đúng (1-4)">
    <button onclick="addQuestion()">Thêm câu hỏi</button>
    <button onclick="logout()">Đăng xuất</button>
  </div>

  <div class="container hidden" id="quizContainer">
    <h2>Bài trắc nghiệm</h2>
    <div id="quizQuestions"></div>
    <button id="submitBtn" onclick="submitQuiz()">Nộp bài</button>
    <button id="resetBtn" class="hidden" onclick="resetQuiz()">Làm lại</button>
    <div class="result" id="resultDisplay"></div>
    <button onclick="logout()">Đăng xuất</button>
  </div>

  <script>
    const defaultQuestions = [
      { q: "Thủ đô của Việt Nam là gì?", a: ["Hà Nội", "Hồ Chí Minh", "Đà Nẵng", "Huế"], correct: 1 },
      { q: "2 + 2 = ?", a: ["3", "4", "5", "2"], correct: 2 }
    ];
    const users = {
      admin: "1234",
      guest: "1234"
    };
    const questionsKey = "quiz_questions";
    const resultsKey = "quiz_results";

    function getQuestions() {
      const data = localStorage.getItem(questionsKey);
      return data ? JSON.parse(data) : defaultQuestions;
    }
    function saveQuestions(list) {
      localStorage.setItem(questionsKey, JSON.stringify(list));
    }

    function login() {
      const u = username.value.trim();
      const p = password.value.trim();
      if (users[u] && users[u] === p) {
        localStorage.setItem("loggedUser", u);
        document.getElementById("loginContainer").classList.add("hidden");
        if (u === "admin") showAdmin();
        else showQuiz();
      } else {
        loginMessage.textContent = "Sai tài khoản hoặc mật khẩu!";
      }
    }

    function logout() {
      localStorage.removeItem("loggedUser");
      location.reload();
    }

    // ==== ADMIN ====
    function showAdmin() {
      adminContainer.classList.remove("hidden");
      renderQuestionsAdmin();
    }

    function renderQuestionsAdmin() {
      const qList = getQuestions();
      const div = document.getElementById("questionList");
      div.innerHTML = "";
      qList.forEach((q, i) => {
        div.innerHTML += `
          <div class="question">
            <b>Câu ${i+1}:</b> <input type="text" value="${q.q}" onchange="updateQuestion(${i}, this.value)">
            <div>
              ${q.a.map((ans, idx) => `
                <input type="text" value="${ans}" onchange="updateAnswer(${i}, ${idx}, this.value)">
              `).join('')}
            </div>
            <label>Đáp án đúng:
              <input type="number" min="1" max="4" value="${q.correct}" onchange="updateCorrect(${i}, this.value)">
            </label>
            <div class="admin-actions">
              <button onclick="deleteQuestion(${i})">Xóa</button>
            </div>
          </div>
        `;
      });
    }

    function updateQuestion(index, newText) {
      const qList = getQuestions();
      qList[index].q = newText;
      saveQuestions(qList);
    }
    function updateAnswer(qIndex, aIndex, newText) {
      const qList = getQuestions();
      qList[qIndex].a[aIndex] = newText;
      saveQuestions(qList);
    }
    function updateCorrect(index, val) {
      const qList = getQuestions();
      qList[index].correct = parseInt(val);
      saveQuestions(qList);
    }
    function deleteQuestion(index) {
      const qList = getQuestions();
      qList.splice(index, 1);
      saveQuestions(qList);
      renderQuestionsAdmin();
    }
    function addQuestion() {
      const qText = newQuestion.value.trim();
      const answers = newAnswers.value.trim().split("\n");
      const correct = parseInt(newCorrect.value);
      if (!qText || answers.length < 4 || !correct) {
        alert("Vui lòng nhập đầy đủ câu hỏi và đáp án!");
        return;
      }
      const qList = getQuestions();
      qList.push({ q: qText, a: answers, correct });
      saveQuestions(qList);
      newQuestion.value = "";
      newAnswers.value = "";
      newCorrect.value = "";
      renderQuestionsAdmin();
    }

    // ==== QUIZ ====
    function showQuiz() {
      quizContainer.classList.remove("hidden");
      renderQuiz();
    }

    function renderQuiz() {
      const qList = getQuestions();
      const div = document.getElementById("quizQuestions");
      div.innerHTML = "";
      qList.forEach((q, i) => {
        div.innerHTML += `
          <div class="question">
            <b>Câu ${i+1}:</b> ${q.q}
            <div class="answers">
              ${q.a.map((ans, idx) => `
                <label><input type="radio" name="q${i}" value="${idx+1}"> ${ans}</label>
              `).join('')}
            </div>
          </div>
        `;
      });
      const user = localStorage.getItem("loggedUser");
      const results = JSON.parse(localStorage.getItem(resultsKey) || "{}");
      if (results[user]?.submitted) {
        showResult(results[user].score, qList.length);
        disableQuiz();
      }
    }

    function submitQuiz() {
      const qList = getQuestions();
      let correctCount = 0;
      qList.forEach((q, i) => {
        const chosen = document.querySelector(`input[name="q${i}"]:checked`);
        if (chosen && parseInt(chosen.value) === q.correct) correctCount++;
      });
      const score = correctCount;
      const user = localStorage.getItem("loggedUser");
      const results = JSON.parse(localStorage.getItem(resultsKey) || "{}");
      results[user] = { score, submitted: true };
      localStorage.setItem(resultsKey, JSON.stringify(results));
      showResult(score, qList.length);
      disableQuiz();
    }

    function disableQuiz() {
      document.querySelectorAll("input[type=radio]").forEach(i => i.disabled = true);
      submitBtn.classList.add("hidden");
      resetBtn.classList.remove("hidden");
    }

    function showResult(score, total) {
      resultDisplay.textContent = `Bạn trả lời đúng ${score}/${total} câu.`;
    }

    function resetQuiz() {
      const user = localStorage.getItem("loggedUser");
      const results = JSON.parse(localStorage.getItem(resultsKey) || "{}");
      delete results[user];
      localStorage.setItem(resultsKey, JSON.stringify(results));
      renderQuiz();
      resultDisplay.textContent = "";
      resetBtn.classList.add("hidden");
      submitBtn.classList.remove("hidden");
    }

    // ==== AUTO LOGIN RESTORE ====
    window.onload = function() {
      const user = localStorage.getItem("loggedUser");
      if (user === "admin") showAdmin();
      else if (user === "guest") showQuiz();
    };
  </script>
</body>
</html>
